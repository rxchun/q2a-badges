/* Q2A Badges */
document.addEventListener("DOMContentLoaded",()=>{document.body.addEventListener("click",e=>{if(e.target&&e.target.matches(".badge-count-link")){let a={badgeSlug:e.target.dataset.slug,type:e.target.dataset.typeSlug,name:e.target.dataset.name,popupTitle:e.target.dataset.popupTitle||null,desc:e.target.dataset.desc,fetchUrlBase:e.target.dataset.fetchUrl,userId:e.target.dataset.userid||0};t(a),document.body.classList.add("no-scroll")}});let e=new Map,t=({badgeSlug:t,type:s,name:r,popupTitle:o,desc:i,fetchUrlBase:c,userId:n=0})=>{let g=document.getElementById("badge-users-"+t),u=document.querySelector(`.badge-count-link[data-slug="${t}"]`);if(u){if(!g){if((g=document.createElement("div")).id="badge-users-"+t,g.className="badge-container-sources",e.has(t)){g.innerHTML=e.get(t),u.parentElement.appendChild(g),d(g,t),l(!1),g.dataset.loaded="true",a(t),g.classList.add("q2a-show-badge-source");return}u.parentElement.appendChild(g)}if(!g.dataset.loaded){let b=null!=o?`<span class="bsh-title">${o}:</span>`:"",p=`<div class="badge-source-container"><div class="badge-source-header flex flex-row"><div class="badge-source-info flex flex-column"><div class="bsh-container">${b}<span class="badge-${s}">${r}</span><span class="badge-source-title-description">${i}</span></div></div><div class="bsh-container"><div class="badge-close-btn flex noSelect">âœ•</div></div></div><ul class="badge-sources-wrapper" data-slug="${t}" data-offset="0" data-fetchurl="${c}" data-userid="${n}"></ul><div class="badge-loading-spinner"><span class="badge-spinner"><div class="bubble-loader"><svg viewBox="0 0 120 30" width="60" height="20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle class="dot" cx="15" cy="15" r="6" /><circle class="dot" cx="60" cy="15" r="6" /><circle class="dot" cx="105" cy="15" r="6" /></svg></div></span></div></div><div class="badge-close-source noSelect"></div>`;g.innerHTML=p,g.dataset.loaded="true",a(t),d(g,t)}g.classList.add("q2a-show-badge-source")}},a=t=>{let a=document.querySelector(`#badge-users-${t} .badge-sources-wrapper`);if(!a||"true"===a.dataset.loading||"true"===a.dataset.done)return;a.dataset.loading="true";let d=parseInt(a.dataset.offset||"0",10),i=a.dataset.fetchurl,c=a.dataset.userid||0;if(!i){console.error("Missing fetch URL base for badge:",t),a.dataset.loading="false";return}let n=`${i}/badges-endpoint/render-page-badges.php`;document.body.classList.contains("qa-template-user")&&(n=`${i}/badges-endpoint/render-profile-badges.php`);let g=`${n}?slug=${encodeURIComponent(t)}&userid=${c}&offset=${d}&limit=15`;e.has(t)||l(!0),fetch(g,{headers:{"X-Requested-With":"Fetch"}}).then(e=>{if(!e.ok)throw Error(`HTTP error! Status: ${e.status}`);return e.text()}).then(s=>{if(s.trim())a.insertAdjacentHTML("beforeend",s),a.dataset.offset=d+15;else{a.dataset.done="true";let r=a.closest(".badge-container-sources");r&&e.set(t,r.outerHTML)}}).catch(e=>{console.error("Failed to load more badge users:",e),s(a,"Failed to load badge users. Please try again.")}).finally(()=>{a.dataset.loading="false",setTimeout(()=>{let s=document.querySelector(".badge-container-sources");if(s){let d=s.querySelector(".badge-sources-wrapper");d&&r(d)&&(a.dataset.loaded="true",e.set(t,s.outerHTML))}},260),setTimeout(()=>{l(!1)},500),void 0!==window.lazyLoadInstance&&"function"==typeof window.lazyLoadInstance.update&&window.lazyLoadInstance.update(),o()})},s=(e,t)=>{if(!e)return;let a=e.querySelector(".badge-error-message");a||((a=document.createElement("div")).className="badge-error-message",e.appendChild(a)),a.textContent=t},d=(e,t)=>{let s=e.querySelector(".badge-sources-wrapper");s&&s.addEventListener("scroll",()=>{s.scrollTop+s.clientHeight>=s.scrollHeight-20&&a(t)})},r=e=>e.scrollHeight<=e.clientHeight&&e.scrollWidth<=e.clientWidth,l=e=>{document.querySelectorAll(".badge-loading-spinner").forEach(t=>{t.classList.toggle("active",e)})};document.body.addEventListener("click",e=>{(e.target.matches(".badge-close-btn")||e.target.matches(".badge-close-source"))&&(document.querySelectorAll(".badge-container-sources").forEach(e=>e.remove()),document.body.classList.remove("no-scroll"))});let o=()=>{let e=document.querySelectorAll(".qa-avatar-image");function t(e){e.offsetWidth>e.offsetHeight&&e.classList.add("wide-image")}e.forEach(e=>{e.complete?t(e):e.addEventListener("load",()=>t(e))})};if(window.location.href.indexOf("badges")>-1){let i=document.querySelector("body.qa-template-user div.qa-part-form-badges-list");i&&window.scrollTo({top:i.getBoundingClientRect().top+window.pageYOffset,behavior:"smooth"})}});
